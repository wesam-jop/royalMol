<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الفئات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // مكون تسجيل الدخول
        function Login({ setToken, setCategory }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const response = await axios.post('/api/categories/login', {
                        email,
                        password,
                    });
                    setToken(response.data.token);
                    setCategory(response.data.category);
                } catch (err) {
                    setError(err.response?.data?.message || 'فشل تسجيل الدخول');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                        <h2 className="text-2xl font-bold mb-6 text-center">تسجيل دخول الشركة</h2>
                        {error && <p className="text-red-500 mb-4">{error}</p>}
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-gray-700 mb-2">الإيميل</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 mb-2">كلمة المرور</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition disabled:bg-blue-300"
                                disabled={loading}
                            >
                                {loading ? 'جاري التحميل...' : 'تسجيل الدخول'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // مكون لوحة التحكم
        function Dashboard({ token, category, setToken, setCategory }) {
            const [name, setName] = useState(category.name);
            const [email, setEmail] = useState(category.email);
            const [password, setPassword] = useState('');
            const [image, setImage] = useState(null);
            const [products, setProducts] = useState([]);
            const [newProduct, setNewProduct] = useState({
                title: '',
                description: '',
                price: '',
                status: 'active',
                stock: '',
                images: [],
            });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [productLoading, setProductLoading] = useState(false);

            // جلب المنتجات عند تحميل المكون
            useEffect(() => {
                const fetchProducts = async () => {
                    setProductLoading(true);
                    try {
                        const response = await axios.get(`/api/products?category_id=${category.id}`, {
                            headers: { Authorization: `Bearer ${token}` },
                        });
                        setProducts(response.data.data);
                    } catch (err) {
                        setError(err.response?.data?.message || 'فشل في جلب المنتجات');
                    } finally {
                        setProductLoading(false);
                    }
                };
                fetchProducts();
            }, [category.id, token]);

            // تحديث بيانات الشركة
            const handleUpdateCategory = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const formData = new FormData();
                if (name !== category.name) formData.append('name', name);
                if (email !== category.email) formData.append('email', email);
                if (password) formData.append('password', password);
                if (image) formData.append('image', image);

                try {
                    const response = await axios.post(`/api/categories/${category.id}`, formData, {
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'multipart/form-data',
                        },
                    });
                    setCategory(response.data.category);
                    setPassword('');
                    setImage(null);
                    alert('تم تحديث الشركة بنجاح');
                } catch (err) {
                    setError(err.response?.data?.message || 'فشل في تحديث الشركة');
                } finally {
                    setLoading(false);
                }
            };

            // إضافة منتج جديد
            const handleAddProduct = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const formData = new FormData();
                formData.append('category_id', category.id);
                formData.append('title', newProduct.title);
                formData.append('description', newProduct.description);
                formData.append('price', newProduct.price);
                formData.append('status', newProduct.status);
                if (newProduct.stock) formData.append('stock', newProduct.stock);
                newProduct.images.forEach((img, index) => formData.append(`images[${index}]`, img));

                try {
                    await axios.post('/api/products', formData, {
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'multipart/form-data',
                        },
                    });
                    setNewProduct({
                        title: '',
                        description: '',
                        price: '',
                        status: 'active',
                        stock: '',
                        images: [],
                    });
                    const response = await axios.get(`/api/products?category_id=${category.id}`, {
                        headers: { Authorization: `Bearer ${token}` },
                    });
                    setProducts(response.data.data);
                    alert('تم إضافة المنتج بنجاح');
                } catch (err) {
                    setError(err.response?.data?.message || 'فشل في إضافة المنتج');
                } finally {
                    setLoading(false);
                }
            };

            // حذف منتج
            const handleDeleteProduct = async (productId) => {
                if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
                setLoading(true);
                setError('');
                try {
                    await axios.delete(`/api/products/${productId}`, {
                        headers: { Authorization: `Bearer ${token}` },
                    });
                    setProducts(products.filter((p) => p.id !== productId));
                    alert('تم حذف المنتج بنجاح');
                } catch (err) {
                    setError(err.response?.data?.message || 'فشل في حذف المنتج');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold">لوحة تحكم الشركة: {category.name}</h2>
                            <button
                                onClick={() => setToken(null)}
                                className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                            >
                                تسجيل الخروج
                            </button>
                        </div>

                        {/* تعديل بيانات الشركة */}
                        <div className="bg-white p-6 rounded-lg shadow-lg mb-8">
                            <h3 className="text-xl font-semibold mb-4">تعديل بيانات الشركة</h3>
                            {error && <p className="text-red-500 mb-4">{error}</p>}
                            <form onSubmit={handleUpdateCategory}>
                                <div className="mb-4">
                                    <label className="block text-gray-700 mb-2">اسم الشركة</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-gray-700 mb-2">الإيميل</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-gray-700 mb-2">كلمة المرور (اتركها فارغة إذا لم ترغب في التغيير)</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-gray-700 mb-2">صورة الشركة</label>
                                    {category.image && (
                                        <img src={category.image} alt="Category" className="w-32 h-32 object-cover mb-2 rounded" />
                                    )}
                                    <input
                                        type="file"
                                        onChange={(e) => setImage(e.target.files[0])}
                                        className="w-full p-2 border rounded"
                                        accept="image/*"
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-blue-300"
                                    disabled={loading}
                                >
                                    {loading ? 'جاري التحميل...' : 'تحديث الشركة'}
                                </button>
                            </form>
                        </div>

                        {/* إدارة المنتجات */}
                        <div className="bg-white p-6 rounded-lg shadow-lg">
                            <h3 className="text-xl font-semibold mb-4">إدارة المنتجات</h3>
                            {/* إضافة منتج جديد */}
                            <form onSubmit={handleAddProduct} className="mb-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-gray-700 mb-2">عنوان المنتج</label>
                                        <input
                                            type="text"
                                            value={newProduct.title}
                                            onChange={(e) => setNewProduct({ ...newProduct, title: e.target.value })}
                                            className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 mb-2">الوصف</label>
                                        <textarea
                                            value={newProduct.description}
                                            onChange={(e) => setNewProduct({ ...newProduct, description: e.target.value })}
                                            className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 mb-2">السعر</label>
                                        <input
                                            type="number"
                                            value={newProduct.price}
                                            onChange={(e) => setNewProduct({ ...newProduct, price: e.target.value })}
                                            className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required
                                            min="1"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 mb-2">الحالة</label>
                                        <select
                                            value={newProduct.status}
                                            onChange={(e) => setNewProduct({ ...newProduct, status: e.target.value })}
                                            className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="active">متوفر</option>
                                            <option value="inactive">غير متوفر</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 mb-2">المخزون</label>
                                        <input
                                            type="number"
                                            value={newProduct.stock}
                                            onChange={(e) => setNewProduct({ ...newProduct, stock: e.target.value })}
                                            className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            min="0"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 mb-2">صور المنتج</label>
                                        <input
                                            type="file"
                                            multiple
                                            onChange={(e) => setNewProduct({ ...newProduct, images: Array.from(e.target.files) })}
                                            className="w-full p-2 border rounded"
                                            accept="image/*"
                                        />
                                    </div>
                                </div>
                                <button
                                    type="submit"
                                    className="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-green-300"
                                    disabled={loading}
                                >
                                    {loading ? 'جاري التحميل...' : 'إضافة المنتج'}
                                </button>
                            </form>

                            {/* قائمة المنتجات */}
                            {productLoading ? (
                                <p className="text-gray-500">جاري تحميل المنتجات...</p>
                            ) : products.length === 0 ? (
                                <p className="text-gray-500">لا توجد منتجات متاحة</p>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {products.map((product) => (
                                        <div key={product.id} className="bg-gray-50 p-4 rounded-lg shadow">
                                            <h4 className="text-lg font-semibold">{product.title}</h4>
                                            <p className="text-gray-600">{product.description}</p>
                                            <p className="text-gray-600">السعر: ${product.price}</p>
                                            <p className="text-gray-600">الحالة: {product.status === 'active' ? 'متوفر' : 'غير متوفر'}</p>
                                            <p className="text-gray-600">المخزون: {product.stock ?? 'غير محدد'}</p>
                                            {product.images.length > 0 && (
                                                <div className="flex gap-2 mt-2">
                                                    {product.images.map((img) => (
                                                        <img
                                                            key={img.id}
                                                            src={img.url}
                                                            alt={product.title}
                                                            className="w-16 h-16 object-cover rounded"
                                                        />
                                                    ))}
                                                </div>
                                            )}
                                            <button
                                                onClick={() => handleDeleteProduct(product.id)}
                                                className="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                                            >
                                                حذف
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // المكون الرئيسي
        function App() {
            const [token, setToken] = useState(null);
            const [category, setCategory] = useState(null);

            return (
                <div>
                    {token && category ? (
                        <Dashboard token={token} category={category} setToken={setToken} setCategory={setCategory} />
                    ) : (
                        <Login setToken={setToken} setCategory={setCategory} />
                    )}
                </div>
            );
        }

        // عرض التطبيق
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>